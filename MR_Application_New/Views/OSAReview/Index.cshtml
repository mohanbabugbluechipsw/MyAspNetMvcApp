@model Model_New.ViewModels.PagedResult<Model_New.ViewModels.OSAReviewViewModel>

@{
    ViewData["Title"] = "OSA Review Data";
}

<div class="container">
    <h2>OSA Review Data</h2>

    <!-- Filter Form -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>Filters</h5>
        </div>
        <div class="card-body">
            <form asp-action="Index" method="get" id="filterForm">
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="MrName">Employee</label>
                            <select asp-for="MrName" class="form-control" id="MrName">
                                <option value="">-- Select Employee --</option>
                                @if (ViewBag.MrNames != null)
                                {
                                    @foreach (var item in ViewBag.MrNames as SelectList)
                                    {
                                        <option value="@item.Value" selected="@(item.Value == ViewBag.SelectedMrName?.ToString())">
                                            @item.Text
                                        </option>
                                    }
                                }
                            </select>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="RSCode">RS Code</label>
                            <input type="text" class="form-control" name="RSCode" id="RSCode" value="@ViewBag.SelectedRSCode" readonly />
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="OutletType">Outlet Type</label>
                            <select class="form-control" name="OutletType" id="OutletType">
                                <option value="">-- Select --</option>
                                @foreach (var type in ViewBag.OutletTypes)
                                {
                                    <option value="@type" selected="@(type == ViewBag.SelectedOutletType)">@type</option>
                                }
                            </select>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="FromDate">From Date</label>
                            <input type="date" class="form-control" name="FromDate" id="FromDate" value="@ViewBag.FromDate?.ToString("yyyy-MM-dd")" />
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="ToDate">To Date</label>
                            <input type="date" class="form-control" name="ToDate" id="ToDate" value="@ViewBag.ToDate?.ToString("yyyy-MM-dd")" />
                        </div>
                    </div>

                    <div class="col-md-3 align-self-end">
                        <button type="submit" class="btn btn-primary">Filter</button>
                    </div>
                </div>
                <input type="hidden" name="PageNumber" id="PageNumber" value="@Model.PageNumber" />
                <input type="hidden" name="PageSize" id="PageSize" value="@Model.PageSize" />
            </form>
        </div>
    </div>

    <!-- Data Table -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5>Review Data</h5>
        </div>
        <div class="card-body">
            @if (!Model.Items.Any())
            {
                <div class="alert alert-warning" role="alert">
                    No review data available for the selected filters.
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-striped table-bordered" id="osaReviewTable">
                        <thead>
                            <tr>
                                <th>RS Code</th>
                                <th>Party HLL Code</th>
                                <th>Question</th>
                                <th>Answer</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.Items)
                            {
                                <tr>
                                    <td>@item.RSCode</td>
                                    <td>@item.PartyHLLCode</td>
                                    <td>@item.QuestionText</td>
                                    <td>@item.Answer</td>
                                    <td>@item.FormattedDate</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }

            <!-- Pagination -->
            @if (Model.Items.Any())
            {
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
                        @if (Model.PageNumber > 1)
                        {
                            <li class="page-item">
                                <a class="page-link" href="#" onclick="goToPage(1)">First</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#" onclick="goToPage(@(Model.PageNumber - 1))">Previous</a>
                            </li>
                        }

                        @for (int i = 1; i <= Math.Ceiling((double)Model.TotalCount / Model.PageSize); i++)
                        {
                            <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                                <a class="page-link" href="#" onclick="goToPage(@i)">@i</a>
                            </li>
                        }

                        @if (Model.PageNumber < Math.Ceiling((double)Model.TotalCount / Model.PageSize))
                        {
                            <li class="page-item">
                                <a class="page-link" href="#" onclick="goToPage(@(Model.PageNumber + 1))">Next</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#" onclick="goToPage(@Math.Ceiling((double)Model.TotalCount / Model.PageSize))">Last</a>
                            </li>
                        }
                    </ul>
                </nav>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Initialize DataTable
            $('#osaReviewTable').DataTable({
                paging: false,
                searching: false,
                info: false
            });

            // Load RS Codes when MR Name changes
            $('#MrName').change(function () {
                var empNo = $(this).val();
                if (empNo) {
                    $.get('@Url.Action("GetRSCodes", "OSAReview")', { mrName: empNo }, function (data) {
                        if (Array.isArray(data) && data.length > 0) {
                            $('#RSCode').val(data[0]);
                        } else {
                            $('#RSCode').val('');
                            alert("No RS Code data available for the selected employee.");
                        }
                    }).fail(function () {
                        alert("Failed to fetch RS Codes.");
                    });
                } else {
                    $('#RSCode').val('');
                }
            });

            // Pagination function
            window.goToPage = function (pageNumber) {
                $('#PageNumber').val(pageNumber);
                $('#filterForm').submit();
            };
        });
    </script>
}
